<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Brains2Heart â€“ Neurocardiology Simulator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      display: flex;
      height: 100vh;
      font-family: 'Segoe UI', sans-serif;
      background: #0a0a0c; 
      color: white;
      overflow: hidden;
    }

    #sidebar {
      width: 320px;
      background: #151518;
      padding: 25px;
      box-shadow: 2px 0 15px rgba(0,0,0,0.5);
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #2a2a2e;
    }

    h2 { margin: 0 0 5px 0; color: #00d4ff; font-size: 1.4rem; }
    .desc { font-size: 0.8rem; color: #777; margin-bottom: 25px; }

    .control { margin-bottom: 22px; }
    .control label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 0.8rem;
      text-transform: uppercase;
      color: #bbb;
    }

    .value-display { font-size: 0.9rem; color: #00d4ff; float: right; }

    input[type=range] {
      width: 100%;
      accent-color: #00d4ff;
      cursor: pointer;
    }

    #status-panel {
      margin-top: auto;
      padding: 15px;
      background: #1c1c21;
      border-radius: 6px;
      border-left: 4px solid #00d4ff;
    }

    #status-text { font-size: 0.85rem; line-height: 1.4; color: #ccc; }

    canvas { flex-grow: 1; outline: none; }
  </style>

  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.152.2/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.152.2/examples/jsm/"
      }
    }
  </script>
</head>
<body>

  <div id="sidebar">
    <h2>Brains2Heart</h2>
    <div class="desc">Biometric Feedback Visualization</div>

    <div class="control">
      <label>Sleep <span class="value-display"><span id="sleepVal">7</span>h</span></label>
      <input id="sleep" type="range" min="4" max="9" step="0.5" value="7">
    </div>

    <div class="control">
      <label>Stress <span class="value-display"><span id="stressVal">20</span>%</span></label>
      <input id="stress" type="range" min="0" max="100" value="20">
    </div>

    <div class="control">
      <label>Exercise <span class="value-display"><span id="exVal">3</span>d/wk</span></label>
      <input id="exercise" type="range" min="0" max="7" value="3">
    </div>

    <div class="control">
      <label>Timeline <span class="value-display"><span id="yearsVal">0</span> yrs</span></label>
      <input id="years" type="range" min="0" max="30" value="0">
    </div>

    <div id="status-panel">
      <strong>Health Forecast:</strong><br>
      <div id="status-text">Select parameters to begin simulation.</div>
    </div>
  </div>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0a0a0c);

    const camera = new THREE.PerspectiveCamera(45, (window.innerWidth - 320) / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 1, 6);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth - 320, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    document.body.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    // --- Lights ---
    scene.add(new THREE.AmbientLight(0xffffff, 0.4));
    const light1 = new THREE.PointLight(0xffffff, 1);
    light1.position.set(5, 5, 5);
    scene.add(light1);

    // --- Models ---
    const loader = new GLTFLoader();
    let brain, heart;

    // Healthy Colors
    const brainColor = new THREE.Color(0xffdbdb); // Healthy Pinkish White
    const heartColor = new THREE.Color(0xd63031); // Healthy Deep Red

    loader.load("./brain.glb", (gltf) => {
      brain = gltf.scene;
      brain.position.x = -1.5;
      scene.add(brain);
      brain.traverse(n => { 
        if(n.isMesh) n.material = new THREE.MeshStandardMaterial({ color: brainColor.clone() }); 
      });
    });

    loader.load("./heart.glb", (gltf) => {
      heart = gltf.scene;
      heart.position.x = 1.5;
      scene.add(heart);
      heart.traverse(n => { 
        if(n.isMesh) n.material = new THREE.MeshStandardMaterial({ color: heartColor.clone() }); 
      });
    });

    // --- Inputs ---
    const iSleep = document.getElementById("sleep");
    const iStress = document.getElementById("stress");
    const iEx = document.getElementById("exercise");
    const iYears = document.getElementById("years");
    const statusText = document.getElementById("status-text");

    function animate() {
      requestAnimationFrame(animate);

      const yrs = parseFloat(iYears.value);
      const slp = parseFloat(iSleep.value);
      const str = parseFloat(iStress.value);
      const exe = parseFloat(iEx.value);

      // Update UI Text
      document.getElementById("sleepVal").textContent = slp;
      document.getElementById("stressVal").textContent = str;
      document.getElementById("exVal").textContent = exe;
      document.getElementById("yearsVal").textContent = yrs;

      const time = Date.now() * 0.001;

      // --- BRAIN LOGIC ---
      if (brain) {
        const sleepDeficit = Math.max(0, 7 - slp);
        // Exercise slows brain shrinkage by 30%
        const shrinkRate = (sleepDeficit * 0.01) * (1 - (exe * 0.05));
        const bScale = 1.0 - (yrs * shrinkRate);
        brain.scale.set(bScale, bScale, bScale);

        // Color Logic: Shift from pinkish-white to pale-grey
        brain.traverse(n => {
          if(n.isMesh) {
            const paleness = Math.min(1, (yrs * sleepDeficit) / 50);
            n.material.color.lerpColors(brainColor, new THREE.Color(0x999999), paleness);
          }
        });
      }

      // --- HEART LOGIC ---
      if (heart) {
        // Exercise mitigates stress impact
        const netStress = Math.max(0, str - (exe * 10));
        const hBaseScale = 1.0 + (netStress * 0.002) + (yrs * 0.004);
        
        // Organic "Lub-Dub" Beat Logic
        // Uses a sharper sine wave to feel more like a pulse
        const beatCycle = time * (0.8 + (str * 0.02)); 
        const heartPulse = 1 + (Math.pow(Math.sin(beatCycle * Math.PI), 4) * 0.08);
        
        heart.scale.set(hBaseScale * heartPulse, hBaseScale * heartPulse, hBaseScale * heartPulse);

        // Visual Damage: Emissive glow only at high stress + years
        heart.traverse(n => {
          if(n.isMesh) {
            n.material.emissive = new THREE.Color(0xff0000);
            n.material.emissiveIntensity = (netStress / 100) * (yrs / 25);
          }
        });
      }

      // --- STATUS FEEDBACK ---
      if (yrs < 2) {
        statusText.innerText = "Baseline readings established. Monitoring physiological trends.";
      } else {
        const heartRisk = (str > 70 && exe < 2);
        const brainRisk = (slp < 6);
        if (heartRisk && brainRisk) statusText.innerHTML = "<span style='color:#ff7675'>CRITICAL:</span> High risk of neuro-cardiac inflammation.";
        else if (heartRisk) statusText.innerText = "Cardiac strain detected. Increase exercise to buffer arterial pressure.";
        else if (brainRisk) statusText.innerText = "Cognitive fatigue likely. Neural volume shows decline due to sleep deficit.";
        else statusText.innerText = "Homeostasis maintained. Lifestyle buffers are effective.";
      }

      controls.update();
      renderer.render(scene, camera);
    }

    animate();

    window.addEventListener("resize", () => {
      const w = window.innerWidth - 320;
      camera.aspect = w / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(w, window.innerHeight);
    });
  </script>
</body>
</html>
